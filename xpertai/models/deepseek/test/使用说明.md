# 测试使用说明

## 📋 快速开始

### 第一步：配置 API Key

1. **在项目根目录（`xpertai/`）创建 `.env` 文件**：
   ```bash
   cd xpertai
   # 如果 .env 文件不存在，从 .env.example 复制
   cp .env.example .env
   ```

2. **编辑 `.env` 文件，填入你的 DeepSeek API Key**：
   ```env
   DEEPSEEK_API_KEY=your_api_key_here
   ```

3. **获取 API Key**：
   - 访问：https://platform.deepseek.com/api_keys
   - 登录后创建或复制你的 API Key

### 第二步：运行测试

#### 方法 1: 简单测试脚本（推荐）

```bash
# 从 deepseek 插件目录运行
cd xpertai/models/deepseek
npx tsx test/test-developer-role-fix-simple.ts
```

#### 方法 2: Jest 单元测试

```bash
# 从项目根目录运行
cd xpertai
npx nx test @cry0100/plugin-deepseek3.0 --testPathPatterns=test-developer-role-fix
```

#### 方法 3: 验证 .env 文件加载

```bash
# 测试 .env 文件是否正确加载
cd xpertai/models/deepseek
npx tsx test/test-env-load.ts
```

## 📁 文件结构

```
test/
├── config.ts                    # 配置文件（从根目录 .env 读取）
├── config.example.ts            # 配置示例（已废弃，仅作参考）
├── test-developer-role-fix-simple.ts  # 简单测试脚本
├── test-developer-role-fix.test.ts    # Jest 单元测试
├── test-env-load.ts             # .env 文件加载测试
├── README.md                    # 详细说明（英文）
├── 使用说明.md                  # 使用说明（中文）
└── .gitignore                   # 忽略 config.ts（已不再需要）
```

## ✅ 测试内容

测试会验证：

1. **System Message 处理**
   - 使用 `deepseek-reasoner` 模型
   - 发送包含 `system` message 的请求
   - 验证不会出现 `developer` role 错误

2. **多轮对话**
   - 测试包含 `reasoning_content` 的多轮对话
   - 验证 `reasoning_content` 正确传递

3. **流式响应**
   - 测试流式响应是否正常工作

## 🎯 预期结果

### ✅ 成功

```
🧪 开始测试 deepseek-reasoner 模型...

📤 发送请求：
   Model: deepseek-reasoner
   Messages: [...]

⏳ 等待 API 响应...

✅ 测试成功！
📥 响应内容：
   [模型的实际响应]

✅ 没有出现 developer role 错误！修复成功！
```

### ❌ 失败

如果仍然报错：
```
❌ 测试失败！
   错误信息: 400 Failed to deserialize the JSON body into the target type: messages[0].role: unknown variant `developer`...

❌ 仍然出现 developer role 错误！
```

## 🔒 安全提示

- ✅ `.env` 文件已在根目录的 `.gitignore` 中，不会被提交到 Git
- ✅ 不要将包含真实 API Key 的文件提交到版本控制
- ✅ 如果 `.env` 文件被意外提交，请立即撤销并更新 API Key

## 🌍 环境变量配置

测试从以下位置读取配置（按优先级）：

1. **根目录 `.env` 文件**（推荐）
   ```env
   DEEPSEEK_API_KEY=your_api_key_here
   DEEPSEEK_BASE_URL=https://api.deepseek.com/v1  # 可选
   DEEPSEEK_TEST_TIMEOUT=30000  # 可选
   ```

2. **系统环境变量**
   ```bash
   # Windows PowerShell
   $env:DEEPSEEK_API_KEY="your_api_key_here"
   
   # Windows CMD
   set DEEPSEEK_API_KEY=your_api_key_here
   
   # Linux/Mac
   export DEEPSEEK_API_KEY=your_api_key_here
   ```

## 🐛 常见问题

### Q: 找不到 .env 文件

**A**: 在项目根目录（`xpertai/`）创建 `.env` 文件：
```bash
cd xpertai
echo "DEEPSEEK_API_KEY=your_api_key_here" > .env
```

### Q: API Key 无效

**A**: 检查：
- API Key 是否正确复制（没有多余空格）
- API Key 是否已过期
- API Key 是否有足够的权限

### Q: 仍然出现 developer role 错误

**A**: 可能原因：
1. 平台仍在使用旧版本代码
2. 需要更新到最新版本

**解决方案**：
```bash
npm cache clean --force
npm uninstall @cry0100/plugin-deepseek3.0
npm install @cry0100/plugin-deepseek3.0@latest
```

### Q: 如何验证 .env 文件是否正确加载？

**A**: 运行配置加载测试：
```bash
npx tsx test/test-env-load.ts
```

如果看到：
```
✅ 配置验证通过！
   .env 文件已正确加载，可以运行测试
```

说明配置加载正常。

## 📝 配置说明

### .env 文件位置

- **路径**: `xpertai/.env`
- **示例文件**: `xpertai/.env.example`
- **Git 状态**: `.env` 文件不会被提交（已在 `.gitignore` 中）

### 配置项说明

| 配置项 | 必需 | 默认值 | 说明 |
|--------|------|--------|------|
| `DEEPSEEK_API_KEY` | ✅ | - | DeepSeek API Key |
| `DEEPSEEK_BASE_URL` | ❌ | `https://api.deepseek.com/v1` | API Base URL |
| `DEEPSEEK_TEST_TIMEOUT` | ❌ | `30000` | 测试超时时间（毫秒） |

### 配置读取机制

1. `test/config.ts` 中的 `loadEnvFromRoot()` 函数会自动查找根目录的 `.env` 文件
2. 解析 `.env` 文件内容（支持注释、空行、引号等）
3. 如果 `.env` 文件中没有，则从系统环境变量读取
4. 如果都没有，使用默认值

## 🎉 开始测试

现在你已经了解了如何配置和运行测试，可以开始测试了！

1. ✅ 确保 `.env` 文件已创建并包含 API Key
2. ✅ 运行测试验证配置是否正确
3. ✅ 运行完整测试套件验证功能

祝你测试顺利！🚀
